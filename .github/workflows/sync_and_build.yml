name: Eden Direct File Replace Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # --- 1. Android ARM64 构建 ---
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Your Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y glslang-tools ccache

      - name: Sync Upstream and Force Replace
        run: |
          # 1. 备份根目录下你那份正确的 util.cpp
          cp util.cpp util.cpp.correct
          
          # 2. 强制同步上游代码
          git remote add upstream https://git.eden-emu.dev/eden-emu/eden.git
          git fetch upstream
          git reset --hard upstream/master
          
          # 3. 强制覆盖到目标路径
          mkdir -p src/video_core/texture_cache/
          cp -f util.cpp.correct src/video_core/texture_cache/util.cpp
          
          # 4. 【关键校验】在日志中打印修改点的代码片段，确保替换成功
          echo "==== 校验修改点 1: .depth ===="
          sed -n '120,135p' src/video_core/texture_cache/util.cpp
          echo "==== 校验修改点 2: TileShift ===="
          sed -n '165,185p' src/video_core/texture_cache/util.cpp
          echo "==== 校验修改点 3: static_assert ===="
          tail -n 20 src/video_core/texture_cache/util.cpp

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Android
        run: |
          chmod +x .ci/android/build.sh
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          VULKAN_HEADERS="$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include"
          .ci/android/build.sh -r -t standard -b Release -DYUZU_ANDROID_ARGS="-DANDROID_ABI=arm64-v8a -DVulkan_INCLUDE_DIR=$VULKAN_HEADERS -DVulkan_HEADERS_INSTALL_DIR=$VULKAN_HEADERS"

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: Eden-Android-Final
          path: artifacts/*.apk

  # --- 2. Windows x64 构建 ---
  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout Your Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Sync and Force Replace
        shell: bash
        run: |
          cp util.cpp util.cpp.correct
          git remote add upstream https://git.eden-emu.dev/eden-emu/eden.git
          git fetch upstream
          git reset --hard upstream/master
          cp -f util.cpp.correct src/video_core/texture_cache/util.cpp
          
          echo "==== Windows 校验修改点 ===="
          sed -n '120,135p' src/video_core/texture_cache/util.cpp

      - name: Install Build Tools
        run: |
          choco install nasm -y
          if (Test-Path "tools/windows/install-vulkan-sdk.ps1") {
              Set-ExecutionPolicy Bypass -Scope Process -Force
              & ./tools/windows/install-vulkan-sdk.ps1
          }
          "VULKAN_SDK=C:\VulkanSDK\1.3.275.0" >> $env:GITHUB_ENV
          "C:\VulkanSDK\1.3.275.0\Bin" >> $env:GITHUB_PATH

      - name: Configure and Build
        run: |
          cmake -G "Visual Studio 17 2022" -A x64 -B build `
            -DYUZU_USE_BUNDLED_VULKAN=ON `
            -DYUZU_USE_QT_WEB_ENGINE=OFF `
            -DENABLE_QT=ON `
            -DYUZU_USE_BUNDLED_FFMPEG=ON `
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Upload Windows Exe
        uses: actions/upload-artifact@v4
        with:
          name: Eden-Windows-Final
          path: build/bin/Release/